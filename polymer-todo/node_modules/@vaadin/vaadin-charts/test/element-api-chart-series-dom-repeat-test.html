<!doctype html>

<head>
  <meta charset="UTF-8">
  <title>vaadin-chart tests</title>
  <script src="../../../wct-browser-legacy/browser.js"></script>
  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
  <script type="module" src="../vaadin-chart.js"></script>
  <script type="module" src="../../../@polymer/polymer/lib/elements/dom-repeat.js"></script>
</head>

<body>

  <dom-module id="chart-series-dom-repeat">
    <template>
      <vaadin-chart id="mychart">
        <template is="dom-repeat" items="{{seriesData}}">
          <vaadin-chart-series values="{{item.data}}"></vaadin-chart-series>
        </template>
      </vaadin-chart>
    </template>

    <script type="module">
import '../vaadin-chart.js';
import '@polymer/polymer/lib/elements/dom-repeat.js';
import { PolymerElement } from '@polymer/polymer/polymer-element.js';
customElements.define('chart-series-dom-repeat', class extends PolymerElement {
  static get is() {
    return 'chart-series-dom-repeat';
  }

  static get properties() {
    return {
      seriesData: {
        type: Array,
        value: () => {
          return [
            {'data': [10096761, 6990386, 9830199, 10373255, 7903685]},
            {'data': [9545219, 9425618, 10835399, 8084422, 8541604]},
            {'data': [8881128, 9330959, 9882444, 8594214, 9153243]}
          ];
        }
      }
    };
  }
});
</script>
  </dom-module>
  <chart-series-dom-repeat></chart-series-dom-repeat>

  <script type="module">
import '../vaadin-chart.js';
import '@polymer/polymer/lib/elements/dom-repeat.js';
import { afterNextRender } from '@polymer/polymer/lib/utils/render-status.js';
describe('High-level Charts Series API with DOM Repeat', function() {
  let chart;
  let chartContainer;
  let element;

  before(function(done) {
    customElements.whenDefined('chart-series-dom-repeat').then(() => {
      element = document.querySelector('chart-series-dom-repeat');
      chart = element.$.mychart;
      chartContainer = chart.$.chart;
      done();
    });
  });

  it('should have 3 series', function(done) {
    afterNextRender(chartContainer, () => {
      expect(chart.configuration.series.length).to.be.equal(3);
      done();
    });
  });

  it('should have one line series with 5 points', function(done) {
    afterNextRender(chartContainer, () => {
      const series = chartContainer.querySelectorAll('.highcharts-series');
      expect(series).to.have.lengthOf(3);
      for (let index = 0; index < series.length; index++) {
        const currentSeries = series[index];
        // IE11 doesn't support SVGElement.classList
        expect(currentSeries.getAttribute('class')).to.include('highcharts-line-series');
        expect(chart.configuration.series[0].data).to.have.lengthOf(element.seriesData[index].data.length);
      }
      done();
    });
  });

  it('push in seriesData should create new series', function(done) {
    afterNextRender(chartContainer, () => {
      element.push('seriesData', {data: [1, 2, 3, 4, 5]});
      setTimeout(function() {
        expect(chart.configuration.series.length).to.be.equal(4);
        done();
      });
    });
  });

  it('set in seriesData should update values', function(done) {
    afterNextRender(chartContainer, () => {
      const newData = [6, 7, 8, 9, 10, 11, 12];
      element.set('seriesData.1', {data: newData});
      const values = chart.configuration.series[1].data.map(data => data.y);
      expect(values).to.have.lengthOf(newData.length);
      expect(values).to.have.members(newData);
      done();
    });
  });

});
</script>
</body>
